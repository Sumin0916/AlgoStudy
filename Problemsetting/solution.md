- 간선을 1개만 사용하는 경우는 쉽게 해결할 수 있습니다.
- 간선을 2개 또는 3개를 사용하는 경우의 답을 구하는 가장 단순한 방법은 다음과 같습니다.
    * 쿼리로 주어진 두 정점 u, v의 모든 이웃 cu, cv 를 보면서
    * cu = cv 이면 간선을 2개 사용하는 경우
    * 간선 (cu, cv)가 존재하면 간선을 3개 사용하는 경우
- 시간 복잡도는 $O(deg(u) × deg(v))$로 시간 초과를 받게 됩니다.
- 하지만 정점의 차수가 아주 작을 때는 이 풀이가 효율적이기 때문에
- 차수가 큰 몇 개의 정점만 다른 방식으로 해결하는 것을 시도해 볼 수 있습니다.
---
- 적당한 상수 $K$ 에 대해, 차수가 $K$ 초과인 정점을 $Large$, 이하인 정점을 $Small$이라고 합시다.
- 정점들의 차수를 모두 더하면 $2M$ 이기 때문에, $Large$ 정점은 최대 $2M/K$ 개 존재합니다.
- 쿼리로 주어진 두 정점이 모두 $Small$이라면 $O(K^2)$에 문제를 해결할 수 있습니다.
- 따라서 두 정점이 모두 $Small$인 쿼리를 모두 처리하는데 $O(QK^2)$이 걸립니다.
---
- 일반성을 잃지 않고, $deg(u) > deg(v)$이고, 쿼리 $(u, v)$가 모두 다르다고 가정합시다.
- 만약 쿼리를 $deg(v)$에 비례하는 시간에 해결할 수 있다면
- 정점 $u$에 대해서 처리해야 하는 $v$가 모두 다르므로
- $u$에 대한 모든 쿼리를 $O(M)$에 해결할 수 있습니다.
- $Large$ 정점은 최대 $O(M/K)$개이므로 시간 복잡도는 $O(M^2/K)$입니다.
- 쿼리를 $deg(v)$에 비례하는 시간에 해결하는 방법을 알아봅시다.
---
- $deg(v)$에 비례하는 시간에 쿼리를 해결하기 위해서는 $v$의 이웃만 고려해야 합니다.
- $u$에서 간선을 2개 이하만 사용해서 갈 수 있는 정점들을 미리 전처리하면
- $v$의 이웃에서 전처리된 정점으로 간선이 있는지만 확인하면 정답을 구할 수 있습니다.
- 전처리는 **DP**나 **SPFA**를 이용해 각 정점마다 $O(M)$에 할 수 있습니다.
- $Large$ 정점은 최대 $O(M/K)$개 존재하므로 전처리하는데 $O(M^2/K)$ 만큼 걸립니다.
- 따라서 $u$가 $Large$ 정점인 경우, 모든 쿼리를 $O(M^2/K)$에 처리할 수 있습니다.
---
- 두 정점이 모두 $Small$이면 $O(QK^2)$, 하나라도 $Large$이면 $O(M^2/K)$ 입니다.
- 따라서 전체 시간 복잡도는 $O(QK^2 + M^2/K)$입니다.
- $K = M^{1/3}$으로 잡으면 $O(QM^{2/3} + M^{5/3})$이 되어서 문제를 해결할 수 있습니다.